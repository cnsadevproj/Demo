# 다했니? 앱 기능 및 게임 메커니즘 정리

## 1. 앱 개요

**다했니?**는 학생들의 학습 루틴을 게임화하여 동기부여를 제공하는 교육용 시스템입니다.

### 핵심 가치
- **공정성**: 현재 쿠키 보유량이 아닌 **변화량** 기준으로 게임 진행
- **동기부여**: 쿠키가 적은 학생도 노력하면 게임에서 유리해질 수 있음
- **협동**: 팀 단위 게임으로 협력 유도

---

## 2. 쿠키 시스템

### 2.1 쿠키 종류
| 종류 | 설명 |
|------|------|
| **현재 쿠키** (cookie) | 학생이 현재 보유한 쿠키 |
| **사용 쿠키** (usedCookie) | 상점에서 사용한 쿠키 |
| **총 쿠키** (totalCookie) | 누적 획득 쿠키 (사용 가능 = 총쿠키 - 사용쿠키) |
| **이전 쿠키** (previousCookie) | 마지막 잔디 새로고침 시점의 쿠키 |
| **초코칩** (chocoChips) | 별도 재화 |

### 2.2 쿠키 변화량 계산
```
쿠키 변화량 = 현재 쿠키 - 이전 쿠키
```
- 게임의 핵심 자원은 **쿠키 변화량**
- 보유량이 많아도 변화량이 적으면 게임에서 불리
- 보유량이 적어도 열심히 해서 변화량이 크면 게임에서 유리

### 2.3 쿠키 획득 방법 (다했니 API)
- 매일 학습 완료 시 쿠키 획득
- 다했니 API에서 자동으로 쿠키 지급

---

## 3. 쿠키 배틀 게임

### 3.1 게임 주기
- **교사가 원하는 시간에 진행** (1주~2주에 한 번)
- 게임 일정은 교사가 자유롭게 결정
- 팀 구성 → 쿠키 축적 기간 → 게임 진행

### 3.2 팀 구성
- **기본 4인 1조** (3~5명 조절 가능)
- 자동 랜덤 배정 또는 교사 수동 배정
- 팀 이름: 자동 생성 (예: "불꽃 드래곤", "번개 피닉스")
- 팀 이모지: 🔥, 🐉, 🦅, 🦁, 🐺, 🦊, 🐻, 🦈 등

### 3.3 게임 자원 계산
```
팀 자원 = Σ(팀원 각각의 쿠키 변화량)
```
- 팀 구성 시점 ~ 게임 시점까지의 각 팀원 쿠키 변화량 합산
- **보너스 쿠키**: 성찰왕 등으로 획득한 추가 쿠키

### 3.4 게임 흐름
```
1. 설정 (Setup)
   - 라운드 수 설정 (기본 3라운드)
   - 손실 메커니즘 선택

2. 배팅 (Betting)
   - 각 팀이 순서대로 배팅
   - 공격 대상 선택 + 공격 쿠키 배분
   - 방어 쿠키 배분

3. 공개 (Reveal)
   - 모든 팀의 배팅 내역 공개

4. 전투 (Battle)
   - 주사위 굴려서 승패 결정
   - 나레이션과 함께 결과 표시

5. 결과 (Results)
   - 라운드 결과 정산
   - 다음 라운드 또는 최종 정산
```

### 3.5 배틀 메커니즘

#### 승률 계산
```
승률 = 공격 쿠키 / (공격 쿠키 + 방어 쿠키) × 100
제한: 최소 10% ~ 최대 90%
```
- 예: 공격 50쿠키 vs 방어 50쿠키 → 승률 50%
- 예: 공격 90쿠키 vs 방어 10쿠키 → 승률 90% (최대)
- 예: 공격 10쿠키 vs 방어 90쿠키 → 승률 10% (최소)

#### 승패 결정
- 1~100 주사위 굴림
- 주사위 결과 ≤ 승률 → 공격 성공
- 주사위 결과 > 승률 → 공격 실패

### 3.6 손실 메커니즘 (3가지)

| 모드 | 승자 획득 | 패자 손실 | 특징 |
|------|----------|----------|------|
| **기본 (추천)** ⚔️ | 상대 배팅의 30% | 배팅 전액 | 균형잡힌 게임 |
| **제로섬 (스릴)** 💀 | 상대 배팅 전액 | 배팅 전액 | 하이리스크 하이리턴 |
| **부드러운 (초보)** 🌸 | 상대 배팅의 20% | 배팅의 50% | 손실 최소화 |

### 3.7 방어 페널티
- 공격받지 않은 팀의 방어 쿠키 → 50% 페널티
- "아무도 안 와서 심심해하다가 쿠키가 상했습니다..."

---

## 4. 잔디 시스템 (학습 기록)

### 4.1 개념
- GitHub 잔디처럼 일일 학습 현황 시각화
- 쿠키 변화량을 날짜별로 기록

### 4.2 구조 (열 기반)
| 학생코드 | 이름 | 2024-11-28 | 2024-11-28(2) | 2024-11-29 |
|---------|------|-----------|--------------|-----------|
| ABC123 | 홍길동 | 5 | 3 | 7 |
| DEF456 | 김철수 | 0 | 2 | 4 |

### 4.3 새로고침
- 교사가 "쿠키 새로고침" 클릭
- 다했니 API에서 현재 쿠키 조회
- 변화량 = 현재쿠키 - 이전쿠키
- 잔디에 기록 + 이전쿠키 업데이트

### 4.4 같은 날 여러 번 새로고침
- 첫 번째: `2024-11-28`
- 두 번째: `2024-11-28(2)`
- 세 번째: `2024-11-28(3)`
- 여러 번 = 진한 잔디 (더 열심히 한 표시)

---

## 5. 성찰왕 시스템

### 5.1 개념
- 교사가 매일/매주 성찰을 잘 한 학생 선정
- 선정된 학생에게 보너스 쿠키 부여

### 5.2 보너스
- 기본 보너스: 100쿠키
- 팀 소속 시 팀 자원에도 추가

### 5.3 미성찰 페널티
- 한 번도 성찰하지 않은 학생 페널티
- 팀 자원에서 차감

---

## 6. 소원의 돌

### 6.1 학생 기능
- 하루 1개 소원 작성 (50자 제한)
- 다른 학생 소원에 좋아요
- 연속 작성 streak 기록

### 6.2 교사 기능
- 소원 목록 조회
- 소원 선정 → 보상 쿠키 지급 (기본 50쿠키)
- 소원 삭제

### 6.3 예시 소원
- "체험학습 가고 싶어요"
- "간식 파티 하고 싶어요"
- "자유 시간 더 주세요"

---

## 7. 상점 시스템

### 7.1 구매 방식
- **총쿠키로 구매** (현재쿠키 X)
- 구매 시 사용쿠키 증가
- 사용 가능 쿠키 = 총쿠키 - 사용쿠키

### 7.2 아이템 카테고리
| 카테고리 | 예시 | 가격대 |
|---------|------|-------|
| 이모지 | 😀, 😎, 🤩, 🥳, 🦁, 🐉, 👑, 💎 | 0~30 |
| 테두리 | 없음, 기본, 무지개, 골드, 네온 | 0~35 |
| 이름효과 | 기본, 무지개, 불꽃, 골드글로우 | 0~25 |
| 배경 | 없음, 점무늬, 별, 하트 | 0~15 |
| 칭호색상 | 빨강, 파랑, 보라, 골드, 무지개 | 0~25 |

### 7.3 프로필 커스터마이징
- 구매한 아이템 장착
- 커스텀 칭호 입력 (5자 제한)

---

## 8. 사용자 역할

### 8.1 교사 (Teacher)
- Sheets URL로 로그인
- 학급 관리 (활성화/비활성화)
- 학생 CSV 업로드
- 쿠키 새로고침
- 팀 구성 및 관리
- 쿠키 배틀 게임 진행
- 성찰왕 선정
- 소원 선정/삭제

### 8.2 학생 (Student)
- 학생코드로 로그인
- 대시보드에서 쿠키/잔디 확인
- 소원의 돌 작성
- 상점에서 아이템 구매
- 프로필 커스터마이징

---

## 9. 데이터 동기화 흐름

```
┌─────────────────────────────────────────────────────────────┐
│                    다했니 API (외부)                          │
│              api.dahandin.com                                │
│                                                             │
│  학생이 다했니 앱에서 학습 완료 → 쿠키 자동 지급              │
└────────────────────────┬────────────────────────────────────┘
                         │
                         │ API 호출 (Apps Script에서)
                         ▼
┌─────────────────────────────────────────────────────────────┐
│                 Google Apps Script                          │
│                                                             │
│  syncStudentInfo() - 학생 쿠키 정보 동기화                   │
│  refreshCookies() - 잔디에 변화량 기록                       │
└────────────────────────┬────────────────────────────────────┘
                         │
                         │ 데이터 저장
                         ▼
┌─────────────────────────────────────────────────────────────┐
│                   Google Sheets                             │
│                                                             │
│  학급_학생 시트: 쿠키 정보 저장                               │
│  학급_잔디 시트: 날짜별 쿠키 변화량 저장                       │
│  학급_팀 시트: 팀 구성 및 쿠키 저장                           │
└────────────────────────┬────────────────────────────────────┘
                         │
                         │ API 호출 (React에서)
                         ▼
┌─────────────────────────────────────────────────────────────┐
│                    React 앱 (프론트엔드)                      │
│                                                             │
│  교사: 데이터 조회/관리, 게임 진행                            │
│  학생: 대시보드, 상점, 소원의 돌                              │
└─────────────────────────────────────────────────────────────┘
```

---

## 10. 핵심 설계 원칙

### 10.1 쿠키 변화량 기반 게임
**왜?**
- 현재 보유량 기준 → 쿠키 많은 학생이 항상 유리
- 변화량 기준 → 지금 적게 있어도 노력하면 유리
- **동기 부여**: "지금부터 열심히 하면 된다!"

### 10.2 팀 협동
**왜?**
- 개인 경쟁 → 상위권만 동기부여
- 팀 경쟁 → 팀원들끼리 서로 격려
- **연대감**: "우리 팀 다같이 열심히 하자!"

### 10.3 확률 기반 배틀
**왜?**
- 쿠키 많으면 무조건 승리? → 재미없음
- 확률 기반 → 약자도 역전 가능
- **긴장감**: "쿠키 적어도 운 좋으면 이길 수 있어!"

### 10.4 교사 주도 게임 일정
**왜?**
- 자동 일정 → 학사 일정과 충돌
- 교사 자유 결정 → 수업 상황에 맞게 조절
- **유연성**: "다음 주는 시험이니까 그 다음 주에 하자"

---

## 11. 구현 현황

### 11.1 완료된 기능
- [x] 교사/학생 로그인
- [x] Google Sheets 연동
- [x] 학급 관리 (활성화/비활성화)
- [x] 학생 CSV 업로드
- [x] 쿠키 새로고침 (잔디 기록)
- [x] 소원의 돌 (작성/좋아요/선정)
- [x] 상점 (아이템 구매)
- [x] 프로필 커스터마이징
- [x] 팀 관리 (생성/자동 배정)
- [x] 쿠키 배틀 UI (배팅/전투/결과)

### 11.2 개발 중인 기능
- [ ] 쿠키 배틀 Sheets 연동 (결과 저장)
- [ ] 성찰왕 시스템 완성
- [ ] 주간/월간 리포트
- [ ] 팀별 통계 대시보드

### 11.3 향후 계획
- [ ] 알림 시스템
- [ ] 학생용 팀 현황 페이지
- [ ] 배틀 히스토리 조회
- [ ] 시즌제 랭킹

---

*최종 업데이트: 2024-12-01*
